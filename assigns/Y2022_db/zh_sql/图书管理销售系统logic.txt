book_category(category_id,category_name);
authors(author_id,author_name,age,sex);
books(isbn,book_name,publisher,pub_year,author,price,category_id);
users(user_id,user_name,sex,age,phone,address);
orders(order_id,order_date,user_id);
orderbooks(order_id,isbn,quantity);



alter table orders add total_price decimal(6,2);

alter table orders drop column total_price;

alter table books alter column price decimal(6,2);

update books set publisher='机械工业出版社' where book_name='Book2';

delete from books where book_name like '%新增%';

-- 查询book的isbn,书名,出版社和出版年份
select isbn, book_name,publisher,pub_year
from books

go
-- 查询在2010年到2019年之间出版的书籍的书名，出版社、出版年份以及作者及书籍类别，按照出版年份降序排列
select book_name,publisher,pub_year, a.author_name, bc.category_name
from books
join authors a on books.author = a.author_id
join book_category bc on books.category_id = bc.category_id
where pub_year between 2010 and 2019
order by pub_year desc;


-- 查询地址A的用户所购买过的图书种类以及购买过图书的总价,列出用户名，购买图书类目数，总购买价，结果按照总价降序排列。

select users.user_name, count(distinct b.category_id) as category_num, sum(b.price*o2.quantity) as total_price
from users
join orders o on users.user_id = o.user_id
join orderbooks o2 on o.order_id = o2.order_id
join books b on o2.isbn = b.isbn
where users.address like '%A%'
group by users.user_name
order by sum(b.price*o2.quantity) desc;


-- 查询购买过至少两种图书的用户信息。
select *
from users
where users.user_id in (
select o.user_id
from orders o
join orderbooks o2 on o.order_id = o2.order_id
join books b on o2.isbn = b.isbn
group by o.user_id
having count(distinct b.category_id)>=2
);

-- 查询购买过计算机类书籍的用户信息和购买过文学类书籍的用户信息，按照userid 排序。
select users.*
from users
join orders o on users.user_id = o.user_id
join orderbooks o2 on o.order_id = o2.order_id
join books b on o2.isbn = b.isbn
join book_category bc on b.category_id = bc.category_id
where bc.category_name like '计算机%'
union
select users.*
from users
join orders o on users.user_id = o.user_id
join orderbooks o2 on o.order_id = o2.order_id
join books b on o2.isbn = b.isbn
join book_category bc on b.category_id = bc.category_id
where bc.category_name like '文学%'
order by user_id;